services:
  librecrawl:
    build: .
    container_name: librecrawl
    ports:
      # In local mode: only localhost (127.0.0.1:5000)
      # In production mode: all interfaces (0.0.0.0:5000) for LAN/WAN access
      - "${HOST_BINDING:-127.0.0.1}:5000:5000"
    volumes:
      # Persist the user database and settings
      - ./data:/app/data
    environment:
      - FLASK_APP=main.py
      - PYTHONUNBUFFERED=1
      # Set to "true" for local mode (no authentication), "false" for production
      - LOCAL_MODE=${LOCAL_MODE:-true}
      # Set to "true" to disable new user registrations
      - REGISTRATION_DISABLED=${REGISTRATION_DISABLED:-false}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM=${SMTP_FROM}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME}
      - MAIN_APP_URL=${MAIN_APP_URL}
      - WORKSHOP_APP_URL=${WORKSHOP_APP_URL}
    restart: unless-stopped
    command: >
      sh -c "
      FLAGS='';
      if [ \"$$LOCAL_MODE\" = \"true\" ]; then
        FLAGS=\"$$FLAGS --local\";
      fi;
      if [ \"$$REGISTRATION_DISABLED\" = \"true\" ]; then
        FLAGS=\"$$FLAGS --disable-register\";
      fi;
      python main.py $$FLAGS"

    # Increase shared memory size for Chrome to prevent crashes
    shm_size: '2gb'
